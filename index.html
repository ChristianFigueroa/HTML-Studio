<!DOCTYPE html>
<html lang='en-US'>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>HTML Studio &#183; ChristianFigueroa.GitHub.io</title>
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,700italic' rel='stylesheet' type='text/css'>
	<style type="text/css">
		@font-face {
			font-family: 'BPreplay';
			font-style: italic;
			font-weight: 700;
			src: local('BPreplay Bold Italic'),,
				 local('BPreplay-BoldItalic')
				 url('/assets/BPreplay-BoldItalics.woff2') format('woff2'),
				 url('/assets/BPreplay-BoldItalics.woff') format('woff'),
				 url('/assets/BPreplay-BoldItalics.ttf') format('truetype');
		}

		body, html {
			margin: 0;
			height: 100%;
			position: relative;
			overflow-y: hidden;
		}

		#overwrite_warning {
			position: fixed;
			height: 100vh;
			width: 100vw;
			display: none;
			z-index: 9999998;
			background: #F5F5F5;
			top: 0;
			left: 0;
			overflow-y: auto;
		}

		#overwrite_continue {
			background: #00acc1;
			border: 0;
			padding: .7em 1.2em;
			font-size: 6vh;
			color: #fff;
			border-radius: .8em;
			margin: 2em 0;
			cursor: pointer;
		}

		#overwrite_continue:active {
			box-shadow: 0 0 .3em .3em rgba(0, 0, 0, 0.3) inset
		}

		#measurementReference {
			height: 1rem;
			width: 1pt;
			visibility: hidden;
			pointer-events: none;
			position: absolute;
			top: -1rem;
			left: -1pt;
		}
		.contextmenuitem {
			background: #F2F2F2;
			font-family: Arial, Calibri, Sego UI, sans-serif;
		}

		.contextmenu {
			padding: .2em 0;
			background-color: #F2F2F2;
			border: 1px solid #DDD;
			box-shadow: .2rem .2rem .4rem 0 rgba(80,80,80,.8);
		}

		.contextmenu:not(.subcontextmenu) {
			font-size: 88%;
		}

		#framecontainer {
			min-height: calc(100% - 4.45rem);
			width: auto;
			position: relative;
			overflow-y: auto;
		}

		#framecontainer > * {
			min-height: 100%;
			width: 100%;
			position: absolute;
			top: 0;
			left: 0;
		}

		#frameback {
			background: #90A4AE;
			background-image: url("svg/back.svg");
			background-size: contain;
		}

		#frame {
			border: 0;
			overflow-y: hidden;
		}

		#frameoverlay {
			overflow: hidden;
			font-family: initial;
		}

		#overlaygrid {
			pointer-events: none;
			background: url("svg/grid.svg");
			background-size: contain;
			opacity: .4;
			display: none;
		}

		#toolbarcontainer {
			height: calc(4.45rem - 1px);
			background: #F0F0F0;
			border-bottom: 1px solid #888;
			z-index: 9999994;
			position: relative;
			box-shadow: 0 2px 3px 3px rgba(0,0,0,.18);
		}

		#headersectionbar {
			padding-left: 8%;
			font-size: 0;
			position: absolute;
			top: calc(1% + 2.2rem);
		}

		.headersection {
			display: inline-block;
			font-family: Arial, sans-serif;
			padding: .3em .55em;
			vertical-align: top;
			cursor: default;
			position: relative;
			font-size: initial;
		}

		.headersection:hover {
			background: #DDD;
		}

		#titlebar {
			text-align: center;
			position: absolute;
			width: 100%;
			font-family: Arial, sans-serif;
			margin-top: .5%;
		}

		#title {
			min-width: 20%;
			max-width: 85%;
			display: inline-block;
			font-size: 1.2rem;
			background: #F0F0F0;
			border: 0;
			text-align: center;
			font-family: Arial, sans-serif;
			padding: .05rem 0;
		}

		#title:hover, #title:focus {
			background: #FFF;
			box-shadow: 0 0 5px 2px rgba(0,172,193,.4);
			border: 1px solid #00acc1;
			margin: -1px;
		}

		#titlewidth {
			display: inline;
			position: absolute;
			visibility: hidden;
			pointer-events: none;
			max-width: 85%;
			left: 0;
			font-size: 1.2rem;
		}

		.placeholder {
			color: rgba(0,0,0,.38);
			font-style: italic;
		}

		#logo {
			height: 100%;
			display: inline-block;
			width: 7%;
			background: #00acc1;
		}

		#tooltip {
			background: #F2F2F2;
			width: 50%;
			height: 8vh;
			min-height: 1.2em;
			position: absolute;
			top: 90%;
			left: 25%;
			box-shadow: .3rem .3rem .6rem 0 rgba(0,0,0,.6);
			border: 1px solid #CCC;
			margin: -1px;
			border-radius: 20vh 8vh 8vh 20vh;
			pointer-events: none;
		}

		#tooltip_icon {
			height: 6vh;
			min-height: calc(1.2em - 1vh);
			width: 6vh;
			min-width: calc(1.2em - 1vh);
			border-radius: 50%;
			background: url("svg/tooltip_icon.svg");
			box-shadow: 0 0 3px 1.5px rgba(0,0,0,.3);
			background-size: contain;
			top: 1vh;
			left: 1vh;
			position: absolute;
		}

		#tooltipinner {
			padding-left: 8vh;
			height: 100%;
			width: auto;
		}

		#tooltiptextcont {
			width: 100%;
			height: 100%;
			display: table;
		}

		#tooltiptext {
			display: table-cell;
			vertical-align: middle;
			text-align: center;
			font-family: Arial, sans-serif;
		}

		#open_file_html {
			display: none;
		}

		#dialogcover {
			z-index: 9999997;
			background: rgba(0,0,0,.7);
			height: 100vh;
			width: 100vw;
			position: fixed;
			display: none;
			top: 0;
			left: 0;
		}

		.dialog { 
			width: 50%;
			height: 75vh;
			background: #F0F0F0;
			text-align: center;
			border-radius: .6em;
			left: calc(25% - 1px);
			margin-top: calc(12.5vh - 1px);
			border: 1px solid #AAA;
			box-shadow: .3rem .3rem 5px 4px rgba(0,0,0,.5);
			font-family: Arial, sans-serif;
			position: relative;
			display: none;
			cursor: pointer;
		}

		.dialog>span {
			font-size: 1.1em;
			display: block;
			margin: .2em 0;
		}

		.dialog>.content {
			height: calc(75vh - 5.9em - 1px);
			width: calc(100% - 4.5em);
			position: relative;
			left: .5em;
			border-radius: inherit;
			background: #FFF;
			border: 1px solid #AAA;
			margin: -1px -1px .5em;
			padding: .75em 1.75em;
			overflow: auto;
			cursor: initial;
		}

		.dialog>.exit {
			height: 1.2em;
			width: 1.2em;
			position: absolute;
			top: .26em;
			right: .5em;
			background: rgba(0, 0, 0, 0) url("svg/exit.svg") 50% 50%/70% 70% no-repeat;
			border: 1px solid #AAA;
			margin: -1px;
			border-radius: .3em;
			cursor: pointer;
		}

		.dialog>.exit.disabled {
			background: #F0F0F0;
			cursor: default;
		}

		.dialog .optioncontainer {
			float: right;
		}

		.dialog .option {
			background: #FFF;
			display: inline-block;
			padding: .3em .5em;
			font-family: Arial, sans-serif;
			border-radius: .3em;
			border: 1px solid #AAA;
			margin: -1px .5em -1px -1px;
			cursor: pointer;
			position: static;
			width: initial;
			float: left;
		}

		.dialog .option:hover, .dialog>.option:focus {
			background: linear-gradient(to bottom, #EEE 0%,#CCC 100%);
		}

		.dialog .option:active {
			background: linear-gradient(to bottom, #BBB 0%,#DDD 100%);
			box-shadow: 0 0 5px 2px rgba(0,0,0,.2) inset;
		}

		.dialog .option.disabled {
			background: #F0F0F0;
			color: #999;
			box-shadow: initial;
			cursor: default;
		}

		.dialog>.content h3 {
			font-weight: normal;
			font-family: Arial, sans-serif;
			margin: 0;
		}

		#id1 {
			width: calc(100% - 2em);
			height: 40vh;
			background: #FFF;
			border: 1em dashed #00acc1;
			display: table;
			table-layout: fixed;
			margin-bottom: .75em;
		}

		#id1.active {
			border-color: #008ca1;
		}

		#id2 {
			margin-top: 2.5em;
			cursor: pointer;
		}

		#id3 {
			font-size: 10vh;
			display: block;
		}

		#id5 {
			font-size: 7vh;
			font-family: "BPreplay", Arial, sans-serif;
			font-style: italic;
			font-weight: 700;
		}

		#id4 {
			height: 100%;
			width: 100%;
			vertical-align: middle;
			display: table-cell;
			color: #00acc1;
			font-family: "BPreplay", Arial, sans-serif;
			font-style: italic;
			font-weight: 700;
			pointer-events: none;
		}

		#id6 {
			font-family: Arial, sans-serif;
			height: 100%;
			text-align: left;
			font-style: normal;
			font-weight: normal;
		}

		#id7 {
			font-family: "Open Sans", Arial, sans-serif;
			font-weight: normal;
			padding: 2.5vh;
			font-size: 3.5vh;
			color: #000;
			font-weight: 600;
			border: 1vh solid #FFF;
			border-radius: 3vh;
		}

		#id8 {
			font-size: 5vh;
			color:#00acc1;
			font-family: "BPreplay", Arial, sans-serif;
			font-weight: 700;
			font-style: italic;
			display: block;
			margin: 5vh 1em;
			line-height: 1.3;
			text-align: center;
		}

		#ide {
			padding: 0;
			height: calc(75vh - 4.4em - 1px);
			width: calc(100% - 1em);
		}

		#idf {
			height: calc(75vh - 6.9em - 1px);
			width: calc(100% - 3.5em);
			margin: 0;
			padding: .75em 1.75em;
			border: 0;
			resize: none;
		}

		#id1.active #id4 {
			color: #008ca1;
		}

		#idi {
			table-layout: fixed;
			width: 100%;
		}

		.cl1 {
			float:left;
		}

		.cl2 {
			float: right;
		}

		.cl3 {
			background: #F2F2F2;
			border: 0;
			padding: .3rem .6rem;
			font-size: 1.1em;
			border-radius: .4em;
			width: calc(100% - 1.4rem);
			margin-bottom: .5rem;
			font-family: Consolas,Monaco,"Ubuntu Mono","Courier New",Courier,monospace;
			box-shadow: 0 1px 5px 0 rgba(0,0,0,.3);
			transition: .15s box-shadow;
		}

		.cl3:focus {
			box-shadow: 0 2px 5px 2px rgba(0,0,0,.3);
		}

		#idk {
			opacity: 0;
			position: absolute;
			top: 0;
			pointer-events: none;
		}

		.nojscrossstripes{
			height:10%;
			width:100%;
			background-image:url("/assets/cross_stripe.svg");
			border-bottom:1.5vh solid #678
		}

		.nojs {
			font-family:"Open Sans",Arial,Helvetica,sans-serif;
			font-size:5vmin;
			text-align:center
		}

		.nojs > span{
			display: block;
			width: 85%;
			margin-left: 7.5%
		}

		img.nojsico {
			height:40vmin;
			width:40vmin;
			display:block;
			margin:auto
		}

		#idm {
			table-layout: fixed;
			width: 100%;
			margin-top: 2em;
			border-collapse: collapse;
		}

		#idm td {
			position: relative;
			cursor: pointer;
			padding-top: .4em;
		}

		.cl5 {
			height: 9.0754vw;
			width: 16.1419vw;
			border: 1px solid #000;
			box-shadow: .2rem .2rem .4rem 0 rgba(80,80,80,.8);
			margin: -1px;
		}

		#idm td:hover {
			background: rgba(0,0,0,.15);
		}

		.cl6 {
			margin: .75em 0 .35em;
			font-family: "Open Sans", Arial, sans-serif;
		}

		#html_editor_display {
			height: 40vh;
			width: 60vh;
			max-width: 50vw;
			background: #DDD;
			position: fixed;
			margin-top: calc(4.45rem - 1px);
			top: 0;
			border: 1px solid #999;
			border-top-left-radius: .6em;
			border-top-right-radius: .6em;
			cursor: pointer;
			box-shadow: .2rem .2rem .4rem 0 rgba(80,80,80,.8);
			z-index: 9999995;
			display: none;
		}

		#ids {
			font-family: Arial, sans-serif;
			display: block;
			width: 100%;
			text-align: center;
			border-top-left-radius: inherit;
			border-top-right-radius: inherit;
		}

		#idp {
			height: calc(40vh - 1.2em);
			border-bottom-left-radius: inherit;
			border-bottom-right-radius: inherit;
			position: relative;
		}

		#idr {
			position: absolute;
			height: inherit;
			width: 100%;
			top: 0;
			border-radius: inherit;
			cursor: grab;
		}

		#idq {
			height: inherit;
			width: 100%;
			border-radius: inherit;
			background: rgba(0,172,193,.5);
		}
	</style>
</head>
<body>
	<noscript><style>a{text-decoration:none;color:#00acc1}a:hover{text-decoration: underline}noscript{z-index:9999999;position:fixed;height:100vh;width:100vw;background:#F5F5F5;top:0;left:0;overflow-y:auto}</style><div class='nojscrossstripes'></div><div class='nojs'><a href='http://enable-javascript.com/'><img class='nojsico' src='/assets/no_js.svg'></a><span>Your broswer settings have your JavaScript disabled. Unfortunately, this page requires JavaScript to work properly. Please <a href='http://enable-javascript.com'>enable JavaScript</a> and refresh to continue.</span></div></noscript>
	<div id='overwrite_warning'><div class='nojscrossstripes'></div><div class='nojs'><img class='nojsico' src='svg/open_windows.svg'><span>This page may be open in another tab. It is dangerous to have two different documents open at once because any changes made on one document may overwrite the other document and screw up some stuff. Even editing two different versions of the same document may have the same affect. If you think this is a mistake and you want to continue (sometimes happens when your browser crashes), click the button below to hide this message.</span><button id='overwrite_continue' title='Hide this message'>Continue to Site</button></div></div>
	<div id='measurementReference'></div>
	<div id='toolbarcontainer'>
		<div id='titlebar'>
			<input type='text' id='title' placeholder='Untitled HTML Document' title='Click to edit'>
			<div id='titlewidth'></div>
		</div>
		<div id='headersectionbar'>
			<div class='headersection' id='section_file'>File</div>
			<div class='headersection' id='section_edit'>Edit</div>
			<div class='headersection' id='section_view'>View</div>
			<div class='headersection' id='section_stylesheets'>Stylesheets</div>
		</div>
		<div id='logo'></div>
	</div>
	<div id='framecontainer'>
		<div id='frameback'></div>
		<iframe id='frame'></iframe>
		<div id='frameoverlay'></div>
		<div id='overlaygrid'></div>
	</div>
	<div id='tooltip'>
		<div id='tooltip_icon'></div>
		<div id='tooltipinner'>
			<div id='tooltiptextcont'>
				<div id='tooltiptext'>Extra information will appear here</div>
			</div>
		</div>
	</div>
	<div id='dialogcover'>
		<div id='dialog_open_file_html' class='dialog'>
			<span>Open File</span>
			<div class='content' id='idb'>
				<h3>Select a file to replace the current document. Keep in mind <strong style='text-decoration:underline'>this action cannot be undone</strong> and any unsaved changes will be deleted.</h3>
				<form id='id2'>
					<div id='id1' ondragover='return this.className="active",false' ondragend='return this.className="",false' ondragleave='return this.className="",false'>
						<div id='id4'>
							<span id='id3'>Drop a file here</span>
							<span id='id5'>or click to select one</span>
						</div>
					</div>
				</form>
			</div>
			<div class='exit' tabindex='0'></div>
			<div class='optioncontainer'>
				<div class='option disabled' tabindex='0' id='id9'>Open File</div>
				<div class='option exit' tabindex='0' id='ida'>Cancel</div>
			</div>
		</div>
		<div id='dialog_edit_html' class='dialog'>
			<span>Edit Node as HTML</span>
			<div class='content' id='ide'>
				<textarea id='idf' spellcheck='false'></textarea>
			</div>
			<div class='exit' tabindex='0'></div>
			<div class='optioncontainer'>
				<div class='option' tabindex='0' id='idd'>Save</div>
				<div class='option exit' tabindex='0' id='idc'>Cancel</div>
			</div>
		</div>
		<div id='dialog_edit_attributes' class='dialog'>
			<span>Edit Node Attributes</span>
			<div class='content' id='idg'>
				<table id='idi'></table>
			</div>
			<div class='exit' tabindex='0'></div>
			<div class='optioncontainer'>
				<div class='option' tabindex='0' id='idh'>Save</div>
				<div class='option exit' tabindex='0'>Cancel</div>
			</div>
		</div>
		<div id='dialog_new_file' class='dialog'>
			<span>Create New File</span>
			<div class='content'>
				<h3>This will create a new document to replace the current one. Keep in mind <strong style='text-decoration:underline'>this action cannot be undone</strong> and any unsaved changes will be deleted. Choose a preset below to replace the document and then press "Create New File".</h3>
				<table id='idm'>
					<tr>
						<td><iframe src='./presets/1.html' class='cl5'></iframe><h4 class='cl6'>Blank</h4></td>
						<td><iframe src='./presets/2.html' class='cl5'></iframe><h4 class='cl6'>Picture Strips</h4></td>
					</tr>
					<tr>
						<td><iframe src='./presets/3.html' class='cl5 cl7'></iframe><h4 class='cl6'>Image w/ Content</h4></td>
						<td id='ido'><iframe src='./presets/add.html' class='cl5' id='idn'></iframe><h4 class='cl6'>Create New Preset</h4></td>
					</tr>
				</table>
			</div>
			<div class='exit' tabindex='0'></div>
			<div class='optioncontainer'>
				<div class='option disabled' tabindex='0' id='idl'>Create New File</div>
				<div class='option exit' tabindex='0'>Cancel</div>
			</div>
		</div>
	</div>
	<div id='html_editor_display'>
		<span id='ids'>HTML Tree</span>
		<div id='idp'>
			<svg id='idq' viewBox='0 0 180 120'></svg>
			<div id='idr' title='Drag to move. Scroll to zoom. Click to select.'></div>
		</div>
	</div>
	<input type='file' id='open_file_html'>
	<script type='text/javascript' src='/JavaScript/Draggable-Elements/Draggable-Elements.js'></script>
	<script type="text/javascript" src="ContextMenu.js"></script>
	<script type="text/javascript">
		"use strict";


		var debug = {
			start: function (ref) {
				var s = performance.now();
				console.log('New Debugger,',ref,', started at',Math.round(s*1000)/1000);
				return {
					cur: 0,
					last: s,
					step: function(num) {
						var t=performance.now();
						this.cur += 1;
						this.cur = num || this.cur;
						console.log('Debugger',ref,'stepped at',Math.round((t-s)*1000)/1000,'| Step:',this.cur,'| Last:',Math.round((t-this.last)*1000)/1000);
						this.last = t;
					}
				}
			}
		}


		!function(){
			window.em = function(){
				return Math.round(document.getElementById('measurementReference').getBoundingClientRect().height * (arguments.length ? +arguments[0]: 1) * 1000) / 1000 + (arguments[1] ? 'px' : 0);
			}
			window.pt = function(){
				return Math.round(document.getElementById('measurementReference').getBoundingClientRect().width * (arguments.length ? +arguments[0] : 1) * 1000) / 1000 + (arguments[1] ? 'px' : 0);
			}
		}();


		!function(){
			// Run on page load
			if (+localStorage.getItem('HTML-Studio_session')) alreadyActive();
			localStorage.setItem('HTML-Studio_session', '1');
			var iframe = document.getElementById('frame'), framewindow = iframe.contentWindow, elements = iframe.contentWindow.document.body.childNodes, overlay = document.getElementById('frameoverlay'), backdialog = document.getElementById('dialogcover'), history = {
				entries: JSON.parse(localStorage.getItem('documentHistoryEntries')) || [],
				update: function() {
					if (~this.currentEntry && framewindow.document.body.outerHTML == this.entries[this.currentEntry].html && document.getElementById('title').value == this.entries[this.currentEntry].title) return;
					this.currentEntry += 1;
					var stylesheethtml = [];
					for (var stylesheets = framewindow.document.querySelectorAll('style'), i = stylesheets.length - 1; i >= 0; i--) {
						stylesheethtml.push(stylesheets[i].outerHTML.replace(stylesheets[i].innerHTML, stylesheets[i].innerHTML.replace(/(^|;|\{|\}|:)\s+/g,'$1').replace(/\s+(?=\{)|;(?=})/g,'')));
					}
					this.entries[this.currentEntry] = {
						html: framewindow.document.body.outerHTML,
						title: document.getElementById('title').value
					};
					localStorage.setItem('HTML-Studio_stylesheets', JSON.stringify(stylesheethtml))
					this.entries = this.entries.slice(0,this.currentEntry + 1);
					localStorage.setItem('documentHistoryEntries', JSON.stringify(this.entries));
					localStorage.setItem('documentHistoryCurrentEntry', this.currentEntry);
					contextmenus[3].getItem(0).disabled = !this.currentEntry;
					contextmenus[3].getItem(1).disabled = this.currentEntry == this.entries.length - 1;
				}
			}, contextmenus =
				[new ContextMenu({
					items: [{
						name: '[Node Info]',
						disabled: true,
						pad: false,
						css: {
							fontFamily: 'monospace',
							fontSize: '1.2em'
						},
						separate: true
					},{
						name: 'Edit Styles&#133;',
						image: 'svg/edit_styles.svg',
						title: 'Allows you to edit the element\'s CSS'
					},{
						name: 'Edit Attributes&#133;',
						func: function(_,close) {
							close();
							backdialog.style.display = 'block';
							document.getElementById('dialog_edit_attributes').style.display = 'block';
							setStyle(document.querySelector('[data-selected-element=selected]').alias);
							var html = '<table id="idi">';
							Array.prototype.forEach.call(document.querySelector('[data-selected-element=selected]').alias.attributes, function(attribute) {
								html += '<tr class="cl4"><td><input type="text" value="' + quoteEscape(attribute.name) + '" placeholder="attribute" class="cl1 cl3"></td><td><input type="text" value="' + quoteEscape(attribute.value) + '" placeholder="value" class="cl2 cl3"></td></td>';
							});
							html += '<tr class="c14"><td><input type="text" placeholder="attribute" class="cl1 cl3"></td><td><input type="text" placeholder="value" class="cl2 cl3"></td></tr><tr class="c14" id="idk"><td><input type="text" placeholder="attribute" class="cl1 cl3" id="idj"></td><td><input type="text" tabindex="-1" placeholder="value" class="cl2 cl3"></td></tr></table>';
							unsetStyle(document.querySelector('[data-selected-element=selected]').alias);
							document.getElementById('idg').innerHTML = html;
							document.getElementById('idi').linkedElement = document.querySelector('[data-selected-element=selected]').alias;
							var finaltr = document.getElementById('idk').previousElementSibling;
							document.getElementById('idj').addEventListener('focus', function() {
								var tr = document.createElement('tr');
								tr.className = 'cl4';
								tr.innerHTML = '<td><input type="text" placeholder="attribute" class="cl1 cl3"></td><td><input type="text" placeholder="value" class="cl2 cl3"></td>';
								this.parentNode.parentNode.parentNode.insertBefore(tr, this.parentNode.parentNode);
								finaltr = tr;
								tr.children[0].children[0].focus();
								[tr.children[0].children[0], tr.children[1].children[0]].forEach(function(element) {
									element.addEventListener('blur', function() {
										setTimeout(function() {
											var tr = element.parentNode.parentNode;
											tr.inputs = [tr.children[0].children[0], tr.children[1].children[0]];
											element.active = false;
											if (!tr.inputs[0].value && !tr.inputs[1].value && !tr.inputs[0].active && !tr.inputs[1].active) {
												tr.parentNode.removeChild(tr);
											};
										},0);
									});
									element.addEventListener('focus', function() {
										element.active = true;
									});
									element.addEventListener('keypress', function(e) {
										if ((e.keyCode == 9 && !e.shiftKey) || e.keyCode == 13 || ((e.charCode == 58 || e.charCode == 61) && element.parentNode.nextElementSibling)) {
											e.preventDefault();
											(element.parentNode.parentNode == finaltr && !element.parentNode.nextElementSibling && !finaltr.children[0].children[0].value && !finaltr.children[1].children[0].value ? document.getElementById('idh') : element.parentNode.nextElementSibling ? element.parentNode.nextElementSibling.children[0] : element.parentNode.parentNode.nextElementSibling.children[0].children[0]).focus();
										};
									});
								});
							});
							Array.prototype.forEach.call(document.querySelectorAll('#idg input:not(#idj)'), function(element) {
								element.addEventListener('blur', function(e) {
									setTimeout(function() {
										var tr = element.parentNode.parentNode;
										tr.inputs = [tr.children[0].children[0], tr.children[1].children[0]];
										element.active = false;
										if (!tr.inputs[0].value && !tr.inputs[1].value && !tr.inputs[0].active && !tr.inputs[1].active) {
											tr.parentNode.removeChild(tr);
										};
									},0);
								});
								element.addEventListener('focus', function(e) {
									element.active = true;
								});
								element.addEventListener('keypress', function(e) {
									if ((e.keyCode == 9 && !e.shiftKey) || e.keyCode == 13 || ((e.charCode == 58 || e.charCode == 61) && element.parentNode.nextElementSibling)) {
										e.preventDefault();
										(element.parentNode.parentNode == finaltr && !element.parentNode.nextElementSibling && !finaltr.children[0].children[0].value && !finaltr.children[1].children[0].value ? document.getElementById('idh') : element.parentNode.nextElementSibling ? element.parentNode.nextElementSibling.children[0] : element.parentNode.parentNode.nextElementSibling.children[0].children[0]).focus();
									};
								});
							});
							document.querySelector('#idg tr:first-child input').focus();
						},
						title: 'Allows you to edit the element\'s attributes',
						image: 'svg/edit_attributes.svg',
						separate: true
					},{
						name: 'Insert Child&#133;',
						title: 'Inserts a child node into the selected node',
						image: 'svg/insert_child.svg',
						separate: true
					},{
						name: 'Select Children',
						image: 'svg/select_children.svg',
						disabledimage: 'svg/select_children_disabled.svg',
						func: function(_,close) {
							close();
							var element = document.querySelector('[data-selected-element=selected]');
							deselect();
							for (var i = element.children.length - 1; i >= 0; i--) {
								element.children[i].setAttribute('data-selected-element', 'selected');
							};
							if (document.querySelectorAll('[data-selected-element=selected]').length > 1) {
								document.getElementById('tooltiptext').innerText = document.querySelectorAll('[data-selected-element=selected]').length + ' nodes selected';
							} else {
								var node = document.querySelector('[data-selected-element=selected]').alias;
								document.getElementById('tooltiptext').innerHTML = document.getElementById('tooltiptext').innerHTML = '<span style="font-family:monospace;font-size:1.15em"><span style="color:#33f">' + node.nodeName.toLowerCase() + '</span>' + (node.id ? '<span style="color:#009">#' + node.id + '</span>' : '') + (node.alias.className && node.alias.className.baseVal ? '<span style="color:#F44"><wbr>.' + node.alias.className.baseVal.replace(/\s+/g,'<wbr>.') + '</span>' : node.alias.className && node.alias.className.baseVal == undefined ? '<span style="color:#F44"><wbr>.' + node.alias.className.replace(/\s+/g,'<wbr>.') + '</span>' : '') + '</span>';
							}
						},
						title: 'Selects all immediate children of the node',
						disabledtitle: 'This node has no children'
					},{
						name: 'Select Parent',
						image: 'svg/select_parent.svg',
						disabledimage: 'svg/select_parent_disabled.svg',
						func: function(_,close) {
							close();
							var node = document.querySelector('[data-selected-element=selected]').parentNode;
							deselect();
							node.setAttribute('data-selected-element','selected');
							node = node.alias;
							document.getElementById('tooltiptext').innerHTML = document.getElementById('tooltiptext').innerHTML = '<span style="font-family:monospace;font-size:1.15em"><span style="color:#33f">' + node.nodeName.toLowerCase() + '</span>' + (node.id ? '<span style="color:#009">#' + node.id + '</span>' : '') + (node.alias.className && node.alias.className.baseVal ? '<span style="color:#F44"><wbr>.' + node.alias.className.baseVal.replace(/\s+/g,'<wbr>.') + '</span>' : node.alias.className && node.alias.className.baseVal == undefined ? '<span style="color:#F44"><wbr>.' + node.alias.className.replace(/\s+/g,'<wbr>.') + '</span>' : '') + '</span>';
						},
						title: 'Selects the immediate parent of the node',
						disabledtitle: 'This node\'s parent cannot be selected'
					},{
						name: 'Edit Text',
						image: 'svg/edit_text.svg',
						func: function(_,close) {
							var element = document.querySelector('[data-selected-element=selected]'), boxshadow = element.alias.style.boxShadow, blurred = 0;
							element.alias.setAttribute('contenteditable','');
							overlay.style.pointerEvents = 'none';
							if (element.alias.focus) element.alias.focus();
							deselect();
							element.alias.style.boxShadow = '0 0 5px 3px #00acc1';
							var pendingUpdate, pendingHistory;
							element.alias.addEventListener('blur', function(e) {
								if (element.alias.childNodes.length > element.alias.alias.childNodes.length && element.alias.lastChild.nodeName.toLowerCase() == 'br') element.alias.removeChild(element.alias.lastChild);
								function temp(e){
									element.alias.dispatchEvent(new Event('blur'));
									framewindow.removeEventListener('click', temp);
									this.removeEventListener('click', temp2);
								}
								function temp2(e) {
									e.stopPropagation();
									framewindow.removeEventListener('click', temp);
									this.removeEventListener('click', temp2);
								}
								if (this.noblur) {
									// This only occurs if an HTML escape sequence replacer was clicked on
									// The contenteditable element remains contenteditable, but the user has the option to click inside the element (continue editing text, keep contenteditable), or outside the element (stop editing, take away contenteditable)
									e.preventDefault();
									this.noblur = false;
									this.focus();
									framewindow.addEventListener('click', temp);
									this.addEventListener('click', temp2);
									return;
								}
								framewindow.removeEventListener('click', temp);
								this.removeEventListener('click', temp2);
								overlay.style.pointerEvents = '';
								this.removeAttribute('contenteditable');
								element.alias.style.boxShadow = boxshadow;
								blurred = 1;
								overlayUpdate();
								history.update();
							});
							element.alias.addEventListener('dblclick', function() {
								this.dispatchEvent(new Event('blur'));
							});
							element.alias.addEventListener('keypress', function(e) {
								if ((e.keyCode == 13 || e.which == 13) && (e.ctrlKey || e.shiftKey || e.altKey)) {
									element.alias.dispatchEvent(new Event('blur'));
								};
								if (!e.charCode && e.keyCode != 8 && e.keyCode != 46) return;
								if (!pendingUpdate) pendingUpdate = setTimeout(function() {
									pendingUpdate = 0;
									element.alias.style.boxShadow = boxshadow;
									overlayUpdate(!blurred);
									if (e.isTrusted) history.update();
									if (!blurred) overlay.style.pointerEvents = 'none';
									for (var children = element.alias.childNodes,i = children.length - 1; i >= 0; i--) {
										if (i && children[i].nodeType == 3 && children[i - 1].nodeType == 3) {
											children[i - 1].textContent += children[i].textContent;
											children[i].parentNode.removeChild(children[i]);
										}
									}
									if (!blurred) {
										element.alias.alias.innerHTML = element.alias.alias.innerHTML.replace(/&(?:amp|#38);((?:[A-z]+|#\d+|#x[A-Fa-f\d]+);)/g, '<span style="border-radius:.2em;background:#00acc1;color:white;pointer-events:initial;cursor:pointer" class="html-escape-sequence-replacer" data-sequence="$&">$&</span>');
										var preelement = element;
										Array.prototype.forEach.call(document.getElementsByClassName('html-escape-sequence-replacer'), function(element) {
											var a = document.createElement('a'), sequence = element.getAttribute('data-sequence');
											a.innerHTML = sequence;
											if (a.innerText == sequence) {
												element.parentNode.removeChild(element);
												return;
											}
											if (!element.parentNode.alias) {
												!function alias (element) {
													if (!element.parentNode.parentNode.alias) alias(element.parentNode);
													var children = element.parentNode.parentNode.childNodes, index = Array.prototype.indexOf.call(children, element.parentNode);
													for (var i = index - 2; i >= 0; i--) {
														if (children[i].className == 'html-escape-sequence-replacer') {
															if (children[i + 1] && children[i + 1].className == 'html-escape-sequence-replacer') index--;
															if (children[i + 1] && children[i + 1].nodeType == 3) index--;
														} else if (children[i].nodeType == 3) {
															if (children[i + 1] && children[i + 1].className == 'html-escape-sequence-replacer') index--;
														}
													}
													element.parentNode.alias = element.parentNode.parentNode.alias.childNodes[index];
												}(element)
											};
											element.title = 'Click to replace with "' + a.innerText + '"';
											element.addEventListener('mousedown', function(e) {
												preelement.alias.noblur = true;
												var count = 0, index = Array.prototype.indexOf.call(element.parentNode.childNodes, element), origIndex = index;
												for (var children = element.parentNode.childNodes, i = index - 1; i >= 0; i--) {
													if (children[i].className == 'html-escape-sequence-replacer') {
														if (children[i + 1] && children[i + 1].className == 'html-escape-sequence-replacer') index--;
														if (children[i + 1] && children[i + 1].nodeType == 3) index--;
													} else if (children[i].nodeType == 3) {
														if (children[i + 1] && children[i + 1].className == 'html-escape-sequence-replacer') index--;
													}
												}
												for (var children = element.parentNode.childNodes, i = origIndex - 1; i >= 0; i--) {
													if (children[i].className != 'html-escape-sequence-replacer' && children[i].nodeType != 3) break;
													if (children[i].className == 'html-escape-sequence-replacer' && children[i].innerText == element.innerText) count++;
												}

												if (!element.parentNode.alias) {
													!function alias (element) {
														if (!element.parentNode.parentNode.alias) alias(element.parentNode);
														var children = element.parentNode.parentNode.childNodes, index = Array.prototype.indexOf.call(children, element.parentNode);
														for (var i = index - 2; i >= 0; i--) {
															if (children[i].className == 'html-escape-sequence-replacer') {
																if (children[i + 1] && children[i + 1].className == 'html-escape-sequence-replacer') index--;
																if (children[i + 1] && children[i + 1].nodeType == 3) index--;
															} else if (children[i].nodeType == 3) {
																if (children[i + 1] && children[i + 1].className == 'html-escape-sequence-replacer') index--;
															}
														}
														element.parentNode.alias = element.parentNode.parentNode.alias.childNodes[index];
													}(element)
												}
												element.parentNode.alias.childNodes[index].textContent = element.parentNode.alias.childNodes[index].textContent.replace(new RegExp('((?:.*?(?=' + sequence + ')' + sequence + '){' + count + '}.*?(?=' + sequence + '))' + sequence + '(.*$)'), function(_,$1,$2){
													return $1 + a.innerText + $2;
												});
												element.parentNode.alias.dispatchEvent(new Event('keypress'));
												element.parentNode.replaceChild(document.createTextNode(a.innerText), element);
											})
										})
									}
									element.alias.style.boxShadow = blurred ? boxshadow : '0 0 5px 3px #00acc1';
								}, 10);
							});
							element.alias.dispatchEvent(new Event('keypress'));
							close();
						},
						title: 'Allows you to edit the element\'s textual content',
						disabledtitle: 'SVG elements should not contain textual content'
					},{
						name: 'Edit as HTML&#133;',
						image: 'svg/edit_as_html.svg',
						func: function(_,close) {
							close();
							backdialog.style.display = 'block';
							document.getElementById('dialog_edit_html').style.display = 'block';
							setStyle(document.querySelector('[data-selected-element=selected]').alias, true);
							document.getElementById('idf').value = document.querySelector('[data-selected-element=selected]').alias[(document.querySelector('[data-selected-element=selected]').alias == framewindow.document.body ? 'inn' : 'out')+ 'erHTML'];
							unsetStyle(document.querySelector('[data-selected-element=selected]').alias, true);
							document.getElementById('idf').linkedElement = document.querySelector('[data-selected-element=selected]').alias;
						},
						title: 'Allows you to edit the node\'s HTML',
						separate: true
					},{
						name: 'Delete Node',
						func: function(_,close) {
							document.querySelector('[data-selected-element=selected]').alias.parentNode.removeChild(document.querySelector('[data-selected-element=selected]').alias);
							overlayUpdate();
							history.update();
							close();
						},
						title: 'Removes node from the document',
						disabledtitle: 'This node cannot be removed from the document',
						image: 'svg/delete.svg',
						disabledimage: 'svg/delete_disabled.svg'
					}]
				}),
				new ContextMenu({
					items: [{
						name: 'Delete Nodes',
						func: function(_,close) {
							var elements = document.querySelectorAll('[data-selected-element=selected]');
							for (var i = elements.length - 1; i >= 0; i--) {
								if (elements[i].alias.parentNode && elements[i].alias != framewindow.document.body) elements[i].alias.parentNode.removeChild(elements[i].alias);
							}
							overlayUpdate();
							history.update();
							close();
						},
						image: 'svg/delete.svg',
						title: 'Removes nodes from the document'
					},{
						name: 'Select Children',
						func: function(_,close) {
							close();
							var elements = document.querySelectorAll('[data-selected-element=selected]')
							deselect();
							Array.prototype.forEach.call(elements, function(element) {
								Array.prototype.forEach.call(element.children, function(child) {
									child.setAttribute('data-selected-element', 'selected');
								})
							});
							if (document.querySelectorAll('[data-selected-element=selected]').length > 1) {
								document.getElementById('tooltiptext').innerText = document.querySelectorAll('[data-selected-element=selected]').length + ' nodes selected';
							} else {
								var node = document.querySelector('[data-selected-element=selected]').alias;
								document.getElementById('tooltiptext').innerHTML = document.getElementById('tooltiptext').innerHTML = '<span style="font-family:monospace;font-size:1.15em"><span style="color:#33f">' + node.nodeName.toLowerCase() + '</span>' + (node.id ? '<span style="color:#009">#' + node.id + '</span>' : '') + (node.className ? '<span style="color:#F44">.' + node.className.replace(/\s+/g,'.') + '</span>' : '') + '</span>';
							}
						},
						image: 'svg/select_children.svg',
						disabledimage: 'svg/select_children_disabled.svg',
						title: 'Selects all direct children of the selected nodes',
						disabledtitle: 'None of the selected nodes have any children'
					}]
				}),
				new ContextMenu({
					items: [{
						name: 'New',
						func: function(_,close) {
							document.getElementById('dialogcover').style.display = 'block';
							document.getElementById('dialog_new_file').style.display = 'block';
							close();
							closeHeaders();
						},
						image: 'svg/new.svg'
					},{
						name: 'Open&#133;',
						func: function(_,close) {
							document.getElementById('dialogcover').style.display = 'block';
							document.getElementById('dialog_open_file_html').style.display = 'block';
							document.getElementById('id2').innerHTML = '<div id="id1" ondragover="return this.className=\'active\',false" ondragend="return this.className=\'\',false" ondragleave="return this.className=\'\',false"><div id="id4"><span id="id3">Drop a file here</span><span id="id5">or click to select one</span></div></div>';
							document.getElementById('idb').scrollTop = 0;
							document.getElementById('id9').className = 'option disabled';
							document.getElementById('id1').addEventListener('drop', function(e) {
								e.preventDefault();
								e.stopPropagation();
								this.className='';
								if (!e.dataTransfer.files.length) return;
								document.getElementById('id4').innerHTML = '<div id="id6"><div id="id7">' + (e.dataTransfer.files[0].name) + '<span style="float:right">' + (e.dataTransfer.files[0].size < 1000 ? e.dataTransfer.files[0].size + ' bytes' : Math.round(e.dataTransfer.files[0].size / 100) / 10 + 'KB') + '</span></div><span id="id8"></span></div>';
								if (e.dataTransfer.files[0].type != 'text/html') return document.getElementById('id8').innerHTML = 'This file format is not allowed. Please only select an HTML file ending in an ".html" extension.',document.getElementById('id7').style.background = '#FFB7B7',document.getElementById('id9').className='option disabled';
								document.getElementById('id7').style.background = '#A6FFA6';
								document.getElementById('id8').innerHTML = 'Make sure your work is saved before pressing "Open File"';
								document.getElementById('id9').className = 'option';
								document.getElementById('id2').file = e.dataTransfer.files[0];
							});
							close();
							closeHeaders();
						},
						title: '(Ctrl+O) Open an HTML file to replace the current document',
						image: 'svg/open.svg'
					},{
						name: 'Download File&#133;',
						disabled: true,
						disabledtitle: 'Work in Progress'
					}]
				}),
				new ContextMenu({
					items: [{
						name: 'Undo',
						func: undo,
						title: '(Ctrl+Z) Reverts most recent change',
						disabledtitle: '(Ctrl+Z) There are no changes to be undone',
						image: 'svg/undo.svg'
					},{
						name: 'Redo',
						func: redo,
						title: '(Ctrl+Y) Restores most recent change',
						disabledtitle: '(Ctrl+Y)There are no changes to be redone',
						image: 'svg/redo.svg'
					},{
						name: 'History',
						disabled: true,
						disabledtitle: 'Work in Progress',
						separate: true
					},{
						name: 'Select All',
						func: function(_,close) {
							close();
							closeHeaders();
							var elements = document.querySelectorAll('#frameoverlay *,#frameoverlay');
							for (var elements = document.querySelectorAll('#frameoverlay, #frameoverlay *'), i = elements.length - 1; i >= 0; i--) {
								elements[i].setAttribute('data-selected-element', 'selected');
								document.getElementById('tooltiptext').innerHTML = elements.length + ' nodes selected'
							}
						},
						title: 'Selects all elements in the document',
						image: 'svg/select_all.svg'
					},{
						name: 'Deselect All',
						func: function(_,close) {
							deselect();
							close();
							closeHeaders();
							document.getElementById('tooltiptext').innerHTML = 'Extra information will appear here'
						},
						title: 'Deselects all elements in the document',
						separate: true,
						image: 'svg/deselect_all.svg'
					},{
						name: 'Defaults',
						disabled: true,
						disabledtitle: 'Work in Progress'
					}]
				}),
				new ContextMenu({
					items: [{
						name: 'Toolbar',
						disabled: true,
						disabledtitle: 'Work in Progress',
						toggle: true,
						toggled: true,
						image: 'svg/checkmark.svg',
						imageoff: 'svg/transparent.svg'
					},{
						name: 'Full Screen',
						func: function(_,close) {
							this.toggled = !this.toggled;
							close();
							closeHeaders();
							if (this.toggled) {
								var body = document.body;
								if (body.requestFullscreen) body.requestFullscreen();
								else if (body.mozRequestFullScreen) body.mozRequestFullScreen();
								else if (body.webkitRequestFullscreen) body.webkitRequestFullscreen();
								else if (body.msRequestFullscreen) body.msRequestFullscreen();
							} else {
								if (document.exitFullscreen) document.exitFullscreen();
								else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
								else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
								else if (document.msExitFullscreen) document.msExitFullscreen();
							}
						},
						disabled: !(HTMLElement.prototype.requestFullscreen || HTMLElement.prototype.mozRequestFullScreen || HTMLElement.prototype.webkitRequestFullscreen || HTMLElement.prototype.msRequestFullscreen),
						title: 'Goes into fullscreen mode',
						disabledtitle: 'Your browser does not support fullscreen mode',
						toggle: true,
						image: 'svg/checkmark.svg',
						imageoff: 'svg/transparent.svg'
					},{
						name: 'HTML Tree',
						func: function(_,close) {
							this.toggled = !this.toggled;
							document.getElementById('html_editor_display').style.display = this.toggled ? 'block' : '';
							updateTree();
							close();
							closeHeaders();
						},
						title: 'Displays the HTML tree of the document',
						toggle: true,
						image: 'svg/checkmark.svg',
						imageoff: 'svg/transparent.svg',
						separate: true
					},{
						name: 'Grid',
						func: function(_,close) {
							this.toggled = !this.toggled;
							document.getElementById('overlaygrid').style.display = this.toggled ? 'block' : '';
							close();
							closeHeaders();
						},
						title: 'Toggles the overlay grid for the document',
						toggle: true,
						image: 'svg/checkmark.svg',
						imageoff: 'svg/transparent.svg'
					},{
						name: 'Tooltip',
						func: function(_,close) {
							this.toggled = !this.toggled;
							close();
							closeHeaders();
							document.getElementById('tooltip').style.display = this.toggled ? '' : 'none';
						},
						title: 'Toggles the tooltip at the bottom of the screen',
						toggle: true,
						toggled: true,
						image: 'svg/checkmark.svg',
						imageoff: 'svg/transparent.svg'
					}]
				}),
				new ContextMenu({
					items: [{
						name: 'Create New&#133;',
						disabled: true,
						disabledtitle: 'Work in Progress'
					},{
						name: 'Import from File&#133;',
						disabled: true,
						disabledtitle: 'Work in Progress'
					},{
						name: 'Import from URL&#133;',
						disabled: true,
						disabledtitle: 'Work in Progress',
						separate: true
					},{
						name: 'No Stylesheets in Document',
						disabled: true,
						disabledtitle: 'Create a new stylesheet or import one to edit'
					}]
				})], css = [], DOM = {}, generations = [];
			// Load document from localStorage or create a new one
			history.currentEntry = +localStorage.getItem('documentHistoryCurrentEntry') || history.entries.length - 1
			if (history.entries.length) {
				framewindow.document.body.outerHTML = history.entries[history.currentEntry].html;
				if (framewindow.document.querySelectorAll('html>head').length > 1) framewindow.document.documentElement.removeChild(framewindow.document.querySelectorAll('html>head')[1]);
				document.getElementById('title').value = history.entries[history.currentEntry].title;
				framewindow.document.body.style.margin = framewindow.document.body.style.margin || '0';
			} else {
				framewindow.document.body.innerHTML = 'This is the <span style="color: #00acc1; font-family: monospace;">&lt;<span>body</span>&gt;</span> element.<div>And this a <span style="color: #00acc1; font-family: monospace;">&lt;div&gt;</span> element.</div><div>Try clicking on elements<br>to select them</div>';
				framewindow.document.body.style.background = 'white';
				framewindow.document.body.style.textAlign = 'center';
				framewindow.document.body.style.fontSize = '1.5em';
				framewindow.document.body.style.fontFamily = 'Arial, sans-serif';
				framewindow.document.body.style.margin = '0';
				framewindow.document.documentElement.style.overflowY = framewindow.document.body.style.overflowY = 'hidden';
			}
			// Get stylesheets
			updateStylesheets();
			// Make sure <head> has a proper title
			framewindow.document.head.appendChild(framewindow.document.createElement('title'));
			framewindow.document.querySelector('title').innerText = document.getElementById('title').value;
			// Disable undo and redo buttons if ncessary
			contextmenus[3].getItem(0).disabled = !history.currentEntry;
			contextmenus[3].getItem(1).disabled = history.currentEntry == history.entries.length - 1;
			// Connect <body> and #overlay elements
			overlay.alias = framewindow.document.body;
			


			// Overlay event listeners
			overlay.addEventListener('contextmenu', function(e){
				e.preventDefault();
				e.stopPropagation();
				var index = document.querySelectorAll('[data-selected-element=selected]').length > 1 ? 1 : 0;
				if (!index) document.querySelector('[data-selected-element=selected]').dispatchEvent(new Event('click'));
				if ((e.target.className.baseVal == undefined ? e.target.className : e.target.className.baseVal).includes('contextmenu')) document.body.removeChild(document.getElementsByClassName('contextmenu')[0]);
				if (!index) {
					var node = document.querySelector('[data-selected-element=selected]') || overlay;
					contextmenus[index].getItem(0).firstChild.firstChild.innerHTML = '<span style="color:#33F">' + node.nodeName.toLowerCase() + '</span>' + (node.alias.id ? '<span style="color:#009"><wbr>#' + node.alias.id + '</span>' : '') + (node.alias.className && node.alias.className.baseVal ? '<span style="color:#F44"><wbr>.' + node.alias.className.baseVal.replace(/\s+/g,'<wbr>.') + '</span>' : node.alias.className && node.alias.className.baseVal == undefined ? '<span style="color:#F44"><wbr>.' + node.alias.className.replace(/\s+/g,'<wbr>.') + '</span>' : '');
					contextmenus[index].getItem(8).disabled = node.alias == framewindow.document.body;
					contextmenus[index].getItem(4).disabled = !node.children.length;
					contextmenus[index].getItem(6).disabled = node instanceof SVGElement;
					contextmenus[index].getItem(5).disabled = node.alias == framewindow.document.body;
				} else {
					contextmenus[index].getItem(1).disabled = (function() {
						for (var elements = document.querySelectorAll('[data-selected-element=selected]'), i = elements.length - 1; i >= 0; i--) {
							if (elements[i].children.length) return false;
						}
						return true;
					})();
				}
				document.body.appendChild(contextmenus[index].node);
				var style = contextmenus[index].node.getBoundingClientRect();
				contextmenus[index].node.style.left = e.clientX - (style.width + e.clientX > window.innerWidth ? style.width - window.innerWidth + e.clientX : 0) + 'px';
				contextmenus[index].node.style.top = e.clientY - (style.height + e.clientY > window.innerHeight ? style.height - window.innerHeight + e.clientY : 0) - em() + 'px';
				contextmenus[index].node.originElement = overlay;
			});
			overlay.addEventListener('click', function(e) {
				e.stopPropagation();
				if (e.shiftKey) {
					overlay.style.background = 'rgba(0,0,0,0)';
					overlay.setAttribute('data-selected-element', overlay.getAttribute('data-selected-element') != 'selected' ? 'selected' : '');
					var nodes = document.querySelectorAll('[data-selected-element=selected]');
					if (nodes.length>1) document.getElementById('tooltiptext').innerHTML = nodes.length + ' nodes selected';
					else if (nodes[0]) document.getElementById('tooltiptext').innerHTML = '<span style="font-family:monospace;font-size:1.15em"><span style="color:#33f">' + nodes[0].alias.nodeName.toLowerCase() + '</span>' + (nodes[0].alias.id ? '<span style="color:#009">#' + nodes[0].alias.id + '</span>' : '') + (nodes[0].alias.className ? '<span style="color:#F44">.' + nodes[0].alias.className.replace(/\s+/g,'.') + '</span>' : '') + '</span>';
					else document.getElementById('tooltiptext').innerHTML = 'Extra information will appear here';
				} else {
					overlay.style.background = 'rgba(0,0,0,0)';
					var selected = overlay.getAttribute('data-selected-element') == 'selected', length = document.querySelectorAll('[data-selected-element=selected]').length;
					deselect();
					overlay.setAttribute('data-selected-element', length > 1 || !e.isTrusted ? 'selected' : selected ? '' : 'selected');
					if (selected) document.getElementById('tooltiptext').innerHTML = 'Extra information will appear here';
					else document.getElementById('tooltiptext').innerHTML = '<span style="font-family:monospace;font-size:1.15em"><span style="color:#33f">' + overlay.alias.nodeName.toLowerCase() + '</span>' + (overlay.alias.id ? '<span style="color:#009">#' + overlay.alias.id + '</span>' : '') + (overlay.alias.className ? '<span style="color:#F44">.' + overlay.alias.className.replace(/\s+/g,'.') + '</span>' : '') + '</span>';
				}
				if (document.selection) document.selection.empty(),iframewindow.document.selection.empty();
				else if (getSelection) getSelection().removeAllRanges(),framewindow.getSelection().removeAllRanges();
				if (!document.querySelectorAll('[data-selected-element=selected]').length) document.getElementById('tooltiptext').innerHTML = '(' + (e.offsetX || e.clientX) + ', ' + (e.clientY - Math.floor(document.getElementById('toolbarcontainer').getBoundingClientRect().height) + document.getElementById('framecontainer').scrollTop) + ')';
				Array.prototype.forEach.call(document.querySelectorAll('rect.html_editor'), function(rect) {
					rect.style.fill = rect.DOM.node.alias.getAttribute('data-selected-element') == 'selected' ? '#00acc1' : '#456';
				});
			});
			overlay.addEventListener('mousemove', function(e) {
				if (!document.querySelectorAll('[data-selected-element=selected]').length) document.getElementById('tooltiptext').innerHTML = '(' + (e.offsetX || e.clientX) + ', ' + (e.clientY - Math.floor(document.getElementById('toolbarcontainer').getBoundingClientRect().height) + document.getElementById('framecontainer').scrollTop) + ')';
			});
			overlay.addEventListener('mouseleave', function() {
				if (!document.querySelectorAll('[data-selected-element=selected]').length) document.getElementById('tooltiptext').innerHTML = 'Extra information will appear here'
			});

			// Other stuff
			// Polyfill for Element.prototype.matches
			if (!Element.prototype.matches) {
				Element.prototype.matches = 
					Element.prototype.matchesSelector || 
					Element.prototype.mozMatchesSelector ||
					Element.prototype.msMatchesSelector || 
					Element.prototype.oMatchesSelector || 
					Element.prototype.webkitMatchesSelector ||
					function(s) {
						var matches = (this.document || this.ownerDocument).querySelectorAll(s),
							i = matches.length;
						while (--i >= 0 && matches.item(i) !== this) {}
						return i > -1;            
					};
			}
			// Fixes font-sizes for "File > New..." iframes
			window.addEventListener('load', function() {
				Array.prototype.forEach.call(document.getElementsByClassName('cl7'), function(element) {
					element.contentWindow.document.body.style.fontSize = '4vh';
				})	
			})
			// Lets dialogs be draggable
			Array.prototype.forEach.call(document.getElementsByClassName('dialog'), function(element) {
				new DraggableElement(element,{bounds:'body'});
			});
			// Prevents content and option buttons from letting a dialog be dragged
			Array.prototype.forEach.call(document.querySelectorAll('.content,.option'), function(element) {
				element.addEventListener('mousedown', function(e) {
					e.stopPropagation();
				})
			});
			// Makes some other things draggable
			new DraggableElement(document.getElementById('html_editor_display'), {bounds: document.getElementById('framecontainer')});
			new DraggableElement(document.getElementById('idr'), {start: function(event,e) {
				e.stopPropagation();
				this.start = {timestamp: event.timestamp, x: event.coordinates.start.x, y: event.coordinates.start.y};
			}, move: function(event) {
				var viewBox = document.getElementById('idq').getAttribute('viewBox').split(' ');
				viewBox[0] = Math.min((Math.max.apply(Math, generations) * 60 + 10) - viewBox[2], Math.max(0, viewBox[0] - event.coordinates.move.last.distance.x));
				viewBox[1] = Math.min((generations.length * 60 + 10) - viewBox[3], Math.max(0, viewBox[1] - event.coordinates.move.last.distance.y));
				document.getElementById('idq').setAttribute('viewBox', viewBox.join(' '));
			}, end: function(event,e) {
				this.style.top = 0;
				this.style.left = 0;
				if (event.timestamp - this.start.timestamp < 400 && Math.hypot(event.coordinates.end.x - this.start.x, event.coordinates.end.y - this.start.y) < 5) {
					this.style.display = 'none';
					var element = document.elementFromPoint(e.clientX, e.clientY);
					this.style.display = '';
					if (!element || element == document.getElementById('idq') || element.nodeName != 'rect') return;
					clickhandler.call(element.DOM.node.alias, {
						stopPropagation: function(){},
						clientX: e.clientX,
						clientY: e.clientY,
						isTrusted: true,
						shiftKey: e.shiftKey
					});
				}
			}, cursor: 'grabbing', inertia: true});



			// Function to update overlay to match iframe
			function overlayUpdate (skipListeners, skipStyle) {
				if (!document.getElementById('frame').contentWindow.document.body) {
					var doc = document.getElementById('frame').contentWindow.document, body = doc.createElement('body');
					doc.documentElement.appendChild(body);
					document.getElementById('frameoverlay').alias = body;
					body.innerHTML = 'The <span style="color: #00acc1; font-family: monospace;">&lt;body&gt;</span> element should not be deleted.<br>All content in the document should be kept as children of the <span>&lt;body&gt;</span> element.';
					body.style.margin = '0';
					body.style.textAlign = 'center';
					body.style.fontFamily = 'Arial, sans-serif';
					body.style.background = 'white';
					body.style.fontSize = '1.5em';
				}
				var elements = framewindow.document.body.childNodes, overlay = document.getElementById('frameoverlay'), body = framewindow.document.body;
				body.alias = overlay;
				overlay.innerHTML = '';

				var contextmenuhandler = function(e){
					var clonednode = this;
					if (document.querySelectorAll('[data-selected-element=selected]').length) clonednode.preventClick = true;
					e.preventDefault();
					e.stopPropagation();
					var index = document.querySelectorAll('[data-selected-element=selected]').length > 1 ? 1 : 0;
					if (!index) clonednode.dispatchEvent(new Event('click'));
					if ((e.target.className.baseVal == undefined ? e.target.className : e.target.className.baseVal).includes('contextmenu')) document.body.removeChild(document.getElementsByClassName('contextmenu')[0]);
					if (!index) {
						var node = document.querySelector('[data-selected-element=selected]') || clonednode;
						contextmenus[index].getItem(0).firstChild.firstChild.innerHTML = '<span style="color:#33F">' + node.nodeName.toLowerCase() + '</span>' + (node.alias.id ? '<span style="color:#009"><wbr>#' + node.alias.id + '</span>' : '') + (node.alias.className && node.alias.className.baseVal ? '<span style="color:#F44"><wbr>.' + node.alias.className.baseVal.replace(/\s+/g,'<wbr>.') + '</span>' : node.alias.className && node.alias.className.baseVal == undefined ? '<span style="color:#F44"><wbr>.' + node.alias.className.replace(/\s+/g,'<wbr>.') + '</span>' : '');
						contextmenus[index].getItem(8).disabled = node.alias == framewindow.document.body;
						contextmenus[index].getItem(4).disabled = !node.children.length;
						contextmenus[index].getItem(6).disabled = node instanceof SVGElement;
						contextmenus[index].getItem(5).disabled = node.alias == framewindow.document.body;
					} else {
						contextmenus[index].getItem(1).disabled = (function() {
							for (var elements = document.querySelectorAll('[data-selected-element=selected]'), i = elements.length - 1; i >= 0; i--) {
								if (elements[i].children.length) return false;
							}
							return true;
						})();
					}
					document.body.appendChild(contextmenus[index].node);
					var style = contextmenus[index].node.getBoundingClientRect();
					contextmenus[index].node.style.left = e.clientX - (style.width + e.clientX > window.innerWidth ? style.width - window.innerWidth + e.clientX : 0) + 'px';
					contextmenus[index].node.style.top = e.clientY - (style.height + e.clientY > window.innerHeight ? style.height - window.innerHeight + e.clientY : 0) - em() + 'px';
					contextmenus[index].node.originElement = clonednode
				};


				if (body.getAttribute('data-html-studio-original-style-attribute')) body.setAttribute('style', body.getAttribute('data-html-studio-original-style-attribute'));
				overlay.setAttribute('style', body.getAttribute('style'));
				css.forEach(function(stylesheet) {
					stylesheet[1].forEach(function(query) {
						if (body.matches(query[0])) {
							query[1].forEach(function(rule) {
								overlay.style[rule[0]] = rule[1];
							})
						}
					})
				});
				body.setAttribute('data-html-studio-original-style-attribute', body.getAttribute('style'));
				body.style.margin = body.style.margin || 0;
				var vh = document.getElementById('framecontainer').getBoundingClientRect().height / 100,
					vw = document.getElementById('framecontainer').getBoundingClientRect().width / 100;
				if (/v(w|h)/.test(overlay.getAttribute('style'))) overlay.setAttribute('style', overlay.getAttribute('style').replace(/(\d+(?:\.\d+))vw/g, function($_, $1) {
					return vw * $1 + 'px';
				}).replace(/(\d+(?:\.\d+))vh/g, function($_, $1) {
					return vh * $1 + 'px';
				}));
				body.setAttribute('style', overlay.getAttribute('style'));

				DOM = {
					name: 'BODY',
					node: body,
					generation: 0,
					children: []
				}

				DOM.parent = DOM;


				for (var i = elements.length - 1; i >= 0; i--) {
					function clone (parent, DOM) {
						if (!skipStyle && this.getAttribute && this.getAttribute('data-html-studio-original-style-attribute')) this.setAttribute('style', this.getAttribute('data-html-studio-original-style-attribute') || '');
						if (this.setAttribute) this.setAttribute('data-html-studio-original-style-attribute', this.getAttribute('style') || '');
						var clonednode = this.cloneNode();
						this.alias = clonednode;
						clonednode.alias = this;
						if (clonednode instanceof Element || clonednode.nodeType == 1) {
							var DOMNodeObject = {
								name: clonednode.nodeName,
								node: clonednode.alias,
								generation: DOM.generation + 1,
								children: [],
								parent: DOM
							};
							clonednode.DOM = DOMNodeObject;
							DOM.children.unshift(DOMNodeObject);
							if (!skipListeners) {
								// On right click pseudo element
								clonednode.addEventListener('contextmenu', contextmenuhandler);
								// On left click pseudo element
								clonednode.addEventListener('click', clickhandler);
							}

							// Applies stylesheet rules to cloned node as style attribute
							css.forEach(function(stylesheet) {
								stylesheet[1].forEach(function(query) {
									if (this.matches(query[0])) {
										query[1].forEach(function(rule) {
											clonednode.style[rule[0]] = rule[1];
										})
									}
								}.bind(this))
							}.bind(this));

							// Since iframe height is changed to match its content (required for synchronized scrolling),
							// vh and vw units will be proportioned incorrectly
							// This fixes that by changing them to px units instead that correctly reflect vh and vw units
							if (/v(w|h)/.test(clonednode.getAttribute('style'))) clonednode.setAttribute('style', clonednode.getAttribute('style').replace(/(\d+(?:\.\d+)?)vw/g, function($_, $1) {
								return vw * $1 + 'px';
							}).replace(/(\d+(?:\.\d+)?)vh/g, function($_, $1) {
								return vh * $1 + 'px';
							}));
							// Sets original node's style to match the clonednode
							// This keeps them synchronised 
							// Since clonednode inherits its style from the original node and gets stylesheets applied,
							// The two nodes' styles should match
							this.setAttribute('style', clonednode.getAttribute('style') || '');
							this.htmlStudioComputedStyles = this.getAttribute('style');
							// Other styles to make them transparent (since they are just an overlay)
							// And to keep the crosshair cursor throughout the entire document
							if (!skipListeners) clonednode.style.cursor = 'crosshair';
							clonednode.style[clonednode instanceof SVGElement && clonednode.nodeName.toLowerCase() != 'svg' ? 'fill' : 'background'] = clonednode.style.color = clonednode.style[clonednode instanceof SVGElement ? 'stroke' : 'borderColor'] = 'rgba(0,0,0,0)'
							clonednode.style.boxShadow = '';
							clonednode.style.fontFamily = (clonednode.style.fontFamily || '') + ', serif';

							// Remove some harmful attributes
							// Prevent actually clicking on links, instead just select them
							if (clonednode.nodeName == 'A') clonednode.removeAttribute('href');
							// Prevent <img>s from blocking the actual nodes (their background was already changed, but not their src)
							if (clonednode.nodeName == 'IMG') {
								clonednode.setAttribute('src','https://upload.wikimedia.org/wikipedia/commons/2/20/16x16.png')
								clonednode.setAttribute('width', Math.round(clonednode.alias.getAttribute('width') || clonednode.alias.getBoundingClientRect().width));
								clonednode.setAttribute('height', Math.round(clonednode.alias.getAttribute('height') || clonednode.alias.getBoundingClientRect().height));
							}
							// Prevent conflicting ids and incorrect inheritance from non-user style sheets
							clonednode.removeAttribute('id');
							// Prevent incorrect inheritance from non-user stylesheets
							clonednode.removeAttribute('class');
						}
						parent.insertBefore(clonednode, parent.firstChild);
						if (this.childNodes.length) {
							for (var i = this.childNodes.length - 1; i >= 0; i--) {
								clone.call(this.childNodes[i], clonednode, DOMNodeObject);
							}
						}
					};
					clone.call(elements[i], overlay, DOM);
				}
				var styles = framewindow.document.body.style;
				for (var style in styles) {
					try {
						overlay.style[style] = framewindow.document.body.style[style];
					} catch (_) {}
				};
				overlay.style.cursor = 'crosshair';
				overlay.style.color = 'rgba(0,0,0,0)';
				overlay.style.background = 'rgba(0,0,0,0)';
				overlay.style.boxShadow = '';
				overlay.style.fontFamily = (overlay.style.fontFamily || '') + ', serif';

				document.getElementById('overlaygrid').style.height = document.getElementById('frameback').style.height = iframe.style.height = Math.ceil(overlay.getBoundingClientRect().height) + 'px';

				updateTree();
			}



			// Some global functions used in different areas
			// Update document CSS stylesheets
			function updateStylesheets() {
				localStorage.setItem('HTML-Studio_stylesheets', localStorage.getItem('HTML-Studio_stylesheets') || '[]');
				css = [];
				!function() {
					var template = document.createElement('template'), allstylesheets = [];
					for (var stylesheets = JSON.parse(localStorage.getItem('HTML-Studio_stylesheets')), i = stylesheets.length - 1; i >= 0; i--) {
						template.innerHTML = stylesheets[i];
						var style = template.content.querySelector('style'), ref = style.getAttribute('data-name') || 'Stylesheet ' + css.length + 1, encoding, stylesheet = document.createElement('style'), offset = 0, fontstylesheet = document.createElement('style');
						stylesheet.setAttribute('data-name', ref);
						css.push([ref,[]]);
						style = style.innerText.trim();
						while (style) {
							if (style[0] == '@') {
								if (style.substring(1,8) == 'charset' && offset == 0) {
									style = style.substring(8);
									if (/^ "[^"]+";/.test(style)) {
										var encoding = style.substring(2).match(/[^"]+";/)[0]
										encoding = encoding.substring(0, encoding.length - 2);;
										style = style.replace(/[^;]+;/,'');
										stylesheet.innerHTML = '@charset "' + encoding + '";';
									} else style.replace(/^[^;]+;/,'');
								} else if (style.substring(1,10) == 'font-face') {
									var html = style.match(/^[^}]*}/)[0].replace(/(;|\{)(?!\n)/g, '$1\n\t').replace(/\t}/g,'}').replace(/(\S)}/g,'$1\n}').replace(/:(?!\s)/g,': ').replace(/(\w)(\s+)}/g, '$1;$2}')
									stylesheet.innerHTML += html;
									fontstylesheet.innerHTML += html + '\n\n';
									style = style.replace(/^[^}]*}/,'');
								}
							} else {
								var query = style.match(/^[^\{]+(?={)/)[0], rules;
								style = style.replace(query, '');
								rules = style.match(/{([^}]*)}/);
								style = style.replace(rules[0], '');
								stylesheet.innerHTML += query.trim() + ' ' + rules[0].replace(/(;|\{)(?!\n)/g, '$1\n\t').replace(/\t}/g,'}').replace(/(\S)}/g,'$1\n}').replace(/:(?!\s)/g, ': ').replace(/(\w)(\s+)}/g, '$1;$2}');
								css[css.length - 1][1].push([query.trim(),[]]);
								rules[1].split(';').forEach(function(rule) {
									if (rule.includes(':')) css[css.length - 1][1][css[css.length - 1][1].length - 1][1].push([rule.split(':')[0].trim(), rule.split(':')[1].trim()]);
								})
							}
							style = style.replace(/^\s+/,'');
							stylesheet.innerHTML += '\n\n';
							offset = 1;
						};
						stylesheet.innerHTML = stylesheet.innerHTML.replace(/\n\n$/,'');
						fontstylesheet.innerHTML = fontstylesheet.innerHTML.replace(/\n\n$/,'');
						framewindow.document.head.appendChild(stylesheet);
						allstylesheets.push(stylesheet.outerHTML);
						if (document.getElementById('user-font-stylesheet')) document.getElementById('user-font-stylesheet').parentNode.removeChild(document.getElementById('user-font-stylesheet'));
						fontstylesheet.id = 'user-font-stylesheet';
						document.head.appendChild(fontstylesheet);
					}
					localStorage.setItem('HTML-Studio_stylesheets', JSON.stringify(allstylesheets));
				}();
			}
			// Deselects all elements and set their background back to transparent
			function deselect () {
				Array.prototype.forEach.call(document.querySelectorAll('[data-selected-element=selected]'), function(element) {
					element.setAttribute('data-selected-element','');
					element.style[element instanceof SVGElement && element.nodeName.toLowerCase() != 'svg' ? 'fill' : 'background'] = 'rgba(0,0,0,0)';
				})
			}
			// Closes header context menus and sets the buttons to the correct background color
			function closeHeaders() {
				Array.prototype.forEach.call(document.getElementsByClassName('headersection'), function(element) {
					sectionopen = false;
					contextmenus.forEach(function(context) {
						if (context.parentNode == document.body) document.body.removeChild(context.node);
					});
					element.style.background = '';
				})
			}
			// Closes dialogs and hides the background overlay
			function closeDialogs() {
				document.getElementById('dialogcover').style.display = '';
				Array.prototype.forEach.call(document.getElementsByClassName('dialog'), function(element) {
					element.style.display = '';
				})
			};
			function quoteEscape(string) {
				return string.replace(/"/g, "&quot;");
			};
			function setStyle(element, doChildren) {
				element = element || framewindow.document.body;
				doChildren = doChildren ? true : arguments.length > 1 ? true : false;
				function style(element) {
					element.htmlStudioComputedStyles = element.getAttribute('style') || '';
					element.setAttribute('style', element.getAttribute('data-html-studio-original-style-attribute') || '');
					element.removeAttribute('data-html-studio-original-style-attribute');
					if (doChildren && element.children) {
						for (var i = element.children.length - 1; i >= 0; i--) {
							style(element.children[i]);
						}
					}
				};
				style(element);
			};
			function unsetStyle(element, doChildren) {
				element = element || framewindow.document.body;
				doChildren = doChildren ? true : arguments.length > 1 ? true : false;
				function style(element) {
					element.setAttribute('data-html-studio-original-style-attribute', element.getAttribute('style') || '');
					element.setAttribute('style', element.htmlStudioComputedStyles);
					if (doChildren && element.children) {
						for (var i = element.children.length - 1; i >= 0; i--) {
							style(element.children[i]);
						}
					}
				};
				style(element);	
			}
			function updateTree() {
				if (!document.getElementById('html_editor_display').style.display) return;
				generations = [];
				function count(DOM, generation) {
					generations[generation] = (generations[generation] || 0) + 1;
					if (DOM.children.length) {
						for (var i = DOM.children.length - 1; i >= 0; i--) {
							count(DOM.children[i], generation + 1);
						}
					}
				};
				count(DOM, 0);
				var fullwidth = Math.max.apply(Math, generations), svg = document.getElementById('idq');
				svg.setAttribute('width', fullwidth * 60 + 10);
				svg.setAttribute('height', generations.length * 60 + 10);

				function fill(arr) {
					return arr.fill ? arr.fill(0) : (function() {
						for (var i = arr.length - 1; i >= 0; i--) {
							arr[i] = 0;
						};
						return arr;
					})();
				}

				var donegenerations = [];
				generations.forEach(function(gen, ind) {
					donegenerations[ind] = fill(new Array(gen));
				});

				function split(num, ind) {
					return num == 1 ? (fullwidth * 60 + 10) / 2 - 25 : (60 + ((fullwidth - num) * 60 / (num - 1))) * (ind) + 10;
				}

				function generateTree(DOM, child) {
					var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect'), line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
					DOM.rect = rect;
					DOM.line = line;
					rect.DOM = DOM;
					line.DOM = DOM;
					rect.setAttribute('y', DOM.generation * 60 + 10);
					rect.setAttribute('x', split(generations[DOM.generation], donegenerations[DOM.generation].lastIndexOf(0)));
					donegenerations[DOM.generation][donegenerations[DOM.generation].lastIndexOf(0)] = 1;
					rect.setAttribute('height', '35');
					rect.setAttribute('width', '50');
					rect.setAttribute('class', 'html_editor')
					rect.style.fill = '#456';
					svg.appendChild(rect);
					if (DOM.parent != DOM) {
						line.setAttribute('x1', +DOM.parent.rect.getAttribute('x') + 25);
						line.setAttribute('y1', +DOM.parent.rect.getAttribute('y') + 35);
						line.setAttribute('x2', +rect.getAttribute('x') + 25);
						line.setAttribute('y2', rect.getAttribute('y'));
						line.style.stroke = '#456';
						line.style.strokeWidth = '1px';
						svg.appendChild(line);
					}
					if (DOM.children) {
						for (var i = DOM.children.length - 1; i >= 0; i--) {
							generateTree(DOM.children[i], i)
						}
					}
				}
				svg.innerHTML = '';
				generateTree(DOM, 0);
			};
			function clickhandler(e) {
				var clonednode = this;
				e.stopPropagation();
				if (clonednode.preventClick) return clonednode.preventClick = false;
				if (e.shiftKey) {
					clonednode.style[clonednode instanceof SVGElement && clonednode.nodeName.toLowerCase() != 'svg' ? 'fill' : 'background'] = 'rgba(0,0,0,0)';
					clonednode.setAttribute('data-selected-element', clonednode.getAttribute('data-selected-element') != 'selected' ? 'selected' : '');
					var nodes = document.querySelectorAll('[data-selected-element=selected]');
					if (nodes.length>1) document.getElementById('tooltiptext').innerHTML = nodes.length + ' nodes selected';
					else if (nodes[0]) document.getElementById('tooltiptext').innerHTML = '<span style="font-family:monospace;font-size:1.15em"><span style="color:#33f">' + nodes[0].alias.nodeName.toLowerCase() + '</span>' + (nodes[0].alias.id ? '<span style="color:#009">#' + nodes[0].alias.id + '</span>' : '') + (nodes[0].alias.className ? '<span style="color:#F44">.' + nodes[0].alias.className.replace(/\s+/g,'.') + '</span>' : '') + '</span>';
					else document.getElementById('tooltiptext').innerHTML = 'Extra information will appear here';
				} else {
					clonednode.style[clonednode instanceof SVGElement && clonednode.nodeName.toLowerCase() != 'svg' ? 'fill' : 'background'] = 'rgba(0,0,0,0)';
					var selected = clonednode.getAttribute('data-selected-element') == 'selected', length = document.querySelectorAll('[data-selected-element=selected]').length;
					deselect();
					clonednode.setAttribute('data-selected-element', length > 1 || !e.isTrusted ? 'selected' : selected ? '' : 'selected');
					if (selected) document.getElementById('tooltiptext').innerHTML = 'Extra information will appear here';
					else document.getElementById('tooltiptext').innerHTML = '<span style="font-family:monospace;font-size:1.15em"><span style="color:#33f">' + clonednode.alias.nodeName.toLowerCase() + '</span>' + (clonednode.alias.id ? '<span style="color:#009">#' + clonednode.alias.id + '</span>' : '') + (clonednode.alias.className && clonednode.alias.className.baseVal ? '<span style="color:#F44">.' + clonednode.alias.className.baseVal.replace(/\s+/g,'.') + '</span>' : clonednode.alias.className && clonednode.alias.className.baseVal == undefined ? '<span style="color:#F44">.' + clonednode.alias.className.replace(/\s+/g,'.') + '</span>' : '') + '</span>';
				}
				if (document.selection) document.selection.empty(),iframewindow.document.selection.empty();
				else if (getSelection) getSelection().removeAllRanges(),framewindow.getSelection().removeAllRanges();
				if (!document.querySelectorAll('[data-selected-element=selected]').length) document.getElementById('tooltiptext').innerHTML = '(' + (e.offsetX || e.clientX) + ', ' + (e.clientY - Math.floor(document.getElementById('toolbarcontainer').getBoundingClientRect().height) + document.getElementById('framecontainer').scrollTop) + ')';
				Array.prototype.forEach.call(document.querySelectorAll('rect.html_editor'), function(rect) {
					rect.style.fill = rect.DOM.node.alias.getAttribute('data-selected-element') == 'selected' ? '#00acc1' : '#456';
				});
			};



			// A bunch of event listeners for elements
			var sectionopen = false;
			Array.prototype.forEach.call(document.getElementsByClassName('headersection'), function(element,index,array){
				element.addEventListener('mousedown', function (e){
					e.stopPropagation();
					sectionopen = !sectionopen;
					if (sectionopen) {
						dispatchEvent(new MouseEvent('mousedown'));
						document.body.appendChild(contextmenus[index + 2].node);
						contextmenus[index + 2].node.style.left = this.getBoundingClientRect().left + 'px';
						contextmenus[index + 2].node.style.top = this.getBoundingClientRect().bottom - em() + 'px';
						this.style.background = '#DDD';
					} else {
						document.body.removeChild(contextmenus[index + 2].node);
						this.style.background = '';
					};
					setTimeout(function(){
						if (document.selection) document.selection.empty();
						else if (getSelection) getSelection().removeAllRanges();
					},0)
				});
				element.addEventListener('mouseenter', function (){
					if (!sectionopen) return;
					Array.prototype.forEach.call(array, function(element, index) {
						element.style.background = '';
						try{
							document.body.removeChild(contextmenus[index + 2].node);
						}catch(_){}
					});
					dispatchEvent(new MouseEvent('mousedown'));
					document.body.appendChild(contextmenus[index + 2].node);
					contextmenus[index + 2].node.style.left = this.getBoundingClientRect().left + 'px';
					contextmenus[index + 2].node.style.top = this.getBoundingClientRect().bottom - em() + 'px';
					this.style.background = '#DDD';
				});
			});
			// Sets document title to match the title on the header
			document.getElementById('title').addEventListener('keypress', function(e) {
				if (e.keyCode == 13) return this.blur();
				setTimeout(function(){
					if (!this.value) this.style.fontStyle = 'italic';
					else this.style.fontStyle = '';
					var width = document.getElementById('titlewidth');
					width.innerText = this.value;
					document.getElementById('title').style.width = width.scrollWidth + em(.6) + 'px';
					document.title = (this.value || 'HTML Studio') + ' \xb7 ChristianFigueroa.GitHub.io';
					framewindow.document.querySelector('title').innerText = this.value;
				}.bind(this),0);
			});
			// Updates document title in history
			document.getElementById('title').addEventListener('blur', function(){
				history.update();
				if (!this.value) this.style.fontStyle = 'italic';
				else this.style.fontStyle = '';
			});
			document.getElementById('title').dispatchEvent(new Event('keypress'));
			// Event listener for file upload window
			document.getElementById('open_file_html').addEventListener('change', function(e) {
				if (!this.files.length) return;
				document.getElementById('id4').innerHTML = '<div id="id6"><div id="id7">' + (this.files[0].name) + '<span style="float:right">' + (this.files[0].size < 1000 ? e.files[0].size + ' bytes' : Math.round(this.files[0].size / 100) / 10 + 'KB') + '</span></div><span id="id8"></span></div>';
				if (this.files[0].type != 'text/html') return document.getElementById('id8').innerHTML = 'This file format is not allowed. Please only select an HTML file ending in an ".html" extension.',document.getElementById('id7').style.background = '#FFB7B7',document.getElementById('id9').className='option disabled';
				document.getElementById('id7').style.background = '#A6FFA6';
				document.getElementById('id8').innerHTML = 'Make sure your work is saved before pressing "Open File"';
				document.getElementById('id9').className='option';
				document.getElementById('id2').file = this.files[0];
			});
			// Onclick event listener for file uploader for File > Open...
			document.getElementById('id2').addEventListener('click', function() {
				document.getElementById('open_file_html').click();
			});
			// Hide warning if button is clicked (2 or more tabs open)
			document.getElementById('overwrite_continue').addEventListener('click', function() {
				document.getElementById('overwrite_warning').style.display = '';
			});
			// Open File button for File > Open...
			document.getElementById('id9').addEventListener('click', function() {
				if (this.className.includes('disabled')) return;
				var reader = new FileReader(), html;
				reader.onload = function() {
					try {
						html = reader.result;
						var body, doc;
						try {
							doc = new DOMParser().parseFromString(html, 'text/html');
							body = doc.body;
						} catch (_) {
							doc = new DOMParser().parseFromString(html, 'text/xml');
							if (doc.children[0].nodeName == 'parsererror') throw Error('The file could not be read as HTML (Update or change your browser!) and was interpretted as malformed XML. Try removing <script> elements or updating/changing your browser to be interpretted correctly.');
							body = doc.getElementsByTagName('body')[0]
						}
						if (!body) throw Error('A <body> element could not be found or the file is malformed. Try updating/changing your browser.');
						var stylesheethtml = [];
						for (var stylesheets = doc.getElementsByTagName('style'), i = stylesheets.length - 1; i >= 0; i--) {
							stylesheethtml.push(stylesheets[i].outerHTML.replace(stylesheets[i].innerHTML, stylesheets[i].innerHTML.replace(/(^|;|\{|\}|:)\s+/g,'$1').replace(/\s+(?=\{)|;(?=})/g,'')));
						}
						localStorage.setItem('documentHistoryEntries', JSON.stringify([{
							html: (body).outerHTML,
							title: (doc.getElementsByTagName('title') ? doc.getElementsByTagName('title')[0] : {innerText:''}).innerText
						}]));
						localStorage.setItem('HTML-Studio_stylesheets', JSON.stringify(stylesheethtml));
						localStorage.setItem('documentHistoryCurrentEntry', 0);
						closeDialogs();
						location.reload();
					} catch(_) {
						console.error(_);
						document.getElementById('id8').innerHTML = 'An error occurred while parsing the file. Make sure the file is valid HTML (and includes a &lt;body&gt;) or try another browser.'
					}
				}
				reader.readAsText(document.getElementById('id2').file);
			});
			// Save HTML button for [Right Click] > Edit as HTML...
			document.getElementById('idd').addEventListener('click', function() {
				var textarea = document.getElementById('idf'), template = document.createElement('template');
				if (textarea.linkedElement == framewindow.document.body) {
					return framewindow.document.body.innerHTML = textarea.value,closeDialogs(),overlayUpdate(),history.update();
				}
				template.innerHTML = textarea.value;
				var children = template.content.childNodes;
				for (var i = children.length - 1; i >= 0; i--) {
					textarea.linkedElement.parentNode.insertBefore(children[i], i == children.length - 1 ? textarea.linkedElement.nextSibling : children[i + 1]);
				}
				textarea.linkedElement.parentNode.removeChild(textarea.linkedElement);
				overlayUpdate(false, true);
				history.update();
				closeDialogs();
			})
			// Top right exit button and Cancel button event listener
			Array.prototype.forEach.call(document.getElementsByClassName('exit'), function(element) {
				element.addEventListener('click', function() {
					if (!this.className.includes('disabled')) closeDialogs();
				})
			});
			// Save Attributes button for [Right Click] > Edit Attributes...
			document.getElementById('idh').addEventListener('click', function() {
				for (var element = document.getElementById('idi').linkedElement, i = element.attributes.length - 1; i >= 0; i--) {
					element.removeAttribute(element.attributes[i].name);
				};
				for (var children = document.getElementById('idi').children[0].children, i = children.length - 1; i >= 0; i--) {
					try {
						element.setAttribute(children[i].children[0].children[0].value, children[i].children[1].children[0].value);
					} catch (_) {};
				};
				overlayUpdate(false, true);
				history.update();
				closeDialogs();
			});
			// Allows for pressing enter on buttons to click them
			Array.prototype.forEach.call(document.querySelectorAll('.option,.exit'), function(element) {
				element.addEventListener('keypress', function(e) {
					if (e.keyCode == 13) element.dispatchEvent(new MouseEvent('click'));
				})
			});
			// Selection of File > New... preset
			Array.prototype.forEach.call(document.querySelectorAll('#idm td:not(#ido)'), function(element) {
				element.addEventListener('click', function(e) {
					document.getElementById('idl').className = 'option';
					Array.prototype.forEach.call(document.querySelectorAll('#idm td'), function(element) {
						element.style.background = '';
					})
					element.style.background = 'rgba(0,172,193,.7)';
				});
			});
			// Open New File button for File > New...
			document.getElementById('idl').addEventListener('click', function() {
				var element = document.querySelector('#idm td[style*=background]');
				if (this.className.includes('disabled') || !element) return;
				var stylesheethtml = [];
				for (var stylesheets = element.children[0].contentWindow.document.querySelectorAll('style'), i = stylesheets.length - 1; i >= 0; i--) {
					stylesheethtml.push(stylesheets[i].outerHTML.replace(stylesheets[i].innerHTML, stylesheets[i].innerHTML.replace(/(^|;|\{|\}|:)\s+/g,'$1').replace(/\s+(?=\{)|;(?=})/g,'')));
				};
				closeDialogs();
				if (element.children[0].className.includes('cl7')) element.children[0].contentWindow.document.body.style.fontSize = '';
				localStorage.setItem('documentHistoryEntries', JSON.stringify([{
					html: element.children[0].contentWindow.document.body.outerHTML,
					title: element.children[0].contentWindow.document.querySelector('title').innerText
				}]));
				localStorage.setItem('HTML-Studio_stylesheets', JSON.stringify(stylesheethtml));
				localStorage.setItem('documentHistoryCurrentEntry', 0);
				location.reload();
			});
			document.getElementById('idr').addEventListener('wheel', function(e) {
				var viewBox = document.getElementById('idq').getAttribute('viewBox').split(' ');
				viewBox[2] = Math.max(0.1, Math.min(Math.max.apply(Math, generations) * 60 + 10, +viewBox[2] + +e.deltaY * 1.5));
				viewBox[3] = Math.max(0.1, Math.min(generations.length * 60 + 10, +viewBox[3] + +e.deltaY));
				viewBox[0] = Math.max(0, Math.min(Math.max.apply(Math,generations) * 60 + 10 - viewBox[2], +viewBox[0] - e.deltaY * .75));
				viewBox[1] = Math.max(0, Math.min(generations.length * 60 + 10 - viewBox[3], +viewBox[1] - e.deltaY / 2))
				document.getElementById('idq').setAttribute('viewBox', viewBox.join(' '));
			});




			// window event listeners
			addEventListener('load', function() {
				Array.prototype.forEach.call(document.getElementsByClassName('cl5'),function(element){
					element.contentWindow.addEventListener('click',function(){
						element.parentNode.dispatchEvent(new MouseEvent('click'));
					});
					element.contentWindow.document.documentElement.style.cursor = 'pointer';
				});
			});
			addEventListener('mousedown',function(e){
				if (!document.getElementsByClassName('contextmenu')[0] || (e.target.className && e.target.className.baseVal == undefined && e.target.className.includes('contextmenu'))) return;
				document.body.removeChild(document.getElementsByClassName('contextmenu')[0] || {});
				if (sectionopen) {
					Array.prototype.forEach.call(document.getElementsByClassName('headersection'), function(element, index) {
						element.style.background = '';
					});
					sectionopen = false;
				}
			});
			function undo () {
				history.currentEntry = Math.max(history.currentEntry - 1, 0);
				framewindow.document.body.outerHTML = history.entries[history.currentEntry].html;
				var title = document.getElementById('title');
				title.value = history.entries[history.currentEntry].title;
				if (!title.value) title.style.fontStyle = 'italic';
				else title.style.fontStyle = '';
				overlayUpdate();
				localStorage.setItem('documentHistoryCurrentEntry', history.currentEntry);
				contextmenus[3].getItem(0).disabled = !history.currentEntry;
				contextmenus[3].getItem(1).disabled = history.currentEntry == history.entries.length - 1;
				deselect();
			}
			function redo () {
				history.currentEntry = Math.min(history.currentEntry + 1, history.entries.length - 1);
				framewindow.document.body.outerHTML = history.entries[history.currentEntry].html;
				var title = document.getElementById('title');
				title.value = history.entries[history.currentEntry].title;
				title.value = history.entries[history.currentEntry].title;
				if (!title.value) title.style.fontStyle = 'italic';
				else title.style.fontStyle = '';
				overlayUpdate();
				localStorage.setItem('documentHistoryCurrentEntry', history.currentEntry);
				contextmenus[3].getItem(1).disabled = history.currentEntry == history.entries.length - 1;
				contextmenus[3].getItem(0).disabled = !history.currentEntry;
				deselect();
			}
			function windowkeypress(e) {
				if ((e.charCode == 122 || e.charCode == 90) && e.ctrlKey) undo();
				else if ((e.charCode == 121 || e.charCode == 89) && e.ctrlKey) redo();
				else if ((e.charCode == 97 || e.charCode == 65) && e.ctrlKey && !e.target.hasAttribute('contenteditable') && e.target.nodeName != 'INPUT' && e.target.nodeName != 'TEXTAREA') {
					e.preventDefault();
					e.stopPropagation();
					var elements = document.querySelectorAll('#frameoverlay *,#frameoverlay');
					for (var elements = document.querySelectorAll('#frameoverlay, #frameoverlay *'), i = elements.length - 1; i >= 0; i--) {
						elements[i].setAttribute('data-selected-element', 'selected');
						document.getElementById('tooltiptext').innerHTML = elements.length + ' nodes selected'
					}
				} else if ((e.charCode == 100 || e.charCode == 68) && e.ctrlKey) {
					e.preventDefault();
					e.stopPropagation();
					deselect();
					document.getElementById('tooltiptext').innerHTML = 'Extra information will appear here'
				} else if ((e.charCode == 111 || e.charCode == 79) && e.ctrlKey) {
					e.preventDefault();
					e.stopPropagation();
					contextmenus[2].getItem(1).dispatchEvent(new MouseEvent('click'));
				}
			}
			addEventListener('keypress', windowkeypress);
			framewindow.addEventListener('keypress', windowkeypress);
			addEventListener('onfullscreenchange' in window ? 'fullscreenchange' : 'onmozfullscreenchange' in window ? 'mozfullscreenchange' : 'onwebkitfullscreenchange' in window ? 'webkitfullscreenchange' : '', function(e) {
					contextmenus[4].getItem(1).toggled = (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement);
			});
			addEventListener('resize', function() {
				document.getElementById('overlaygrid').style.height = document.getElementById('frameback').style.height = iframe.style.height = overlay.getBoundingClientRect().height + 'px';
				overlayUpdate();
			});
			addEventListener('unload', function() {
				if (!document.getElementById('overwrite_warning').style.display) localStorage.setItem('HTML-Studio_session', '0');
			})


			// Main interval
			var currentFrame = 0;
			setInterval(function() {
				currentFrame = (currentFrame + 1) % 50;
				var opacity = -Math.abs(currentFrame - 25) + 25, bgcolor = 'rgb(' + opacity * 2 + ',' + Math.round(opacity * 2 + 172) + ',' + Math.round(opacity * 2 + 193) +')', tcolor = 'rgb(' + Math.round((-opacity + 25) * 2.55 + 191) + ',' + Math.round((-opacity + 25) * 2.55 + 191) + ',' + Math.round((-opacity + 25) * 2.55 + 191) +')';
				Array.prototype.forEach.call(document.querySelectorAll('[data-selected-element=selected]'), function(element) {
					element.style[element instanceof SVGElement && element.nodeName.toLowerCase() != 'svg' ? 'fill' : 'background'] = 'rgba(0,172,193,'+(.006*opacity+.15)+')';
				});
				Array.prototype.forEach.call(document.getElementsByClassName('html-escape-sequence-replacer'), function(element) {
					//element.style.backgroundColor = bgcolor;
					element.style.color = tcolor;
				});
			}, 20);



			// Runs if HTML-Studio is already active in another window
			function alreadyActive() {
				document.getElementById('overwrite_warning').style.display = 'block';
			}


			overlayUpdate();
			history.update();
		}();
	</script>
</body>
</html>
